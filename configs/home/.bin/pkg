#! /bin/lua

-- exit program with error message and status code.
function exit(message)
    io.stderr:write("error: " .. message .. "\n")
    os.exit(1)
end

-- execute shell command.
function exec(cmd)
    local s = os.execute(cmd)
    return s == true
end

-- get user provided args as array.
function get_pkg_array()
	local pkgs = {}
	for i = 2, #arg do
    	pkgs[i-1] = arg[i]
	end
	return pkgs
end

-- convert pkg array into a space-separated string.
function collect_pkgs(pkgs)
    local output = ""
    for _, pkg in ipairs(pkgs) do
        output = output .. pkg .. " "
    end

    return output
end

-- display program usage details and exit.
function print_help()
	local help = [[
usage: pkg [COMMAND] [PACKAGES]

commands:
  help    (h)    display this help message and exit.
  search  (s)    search for packages.
  install (i)    install new packages.
  update  (u)    fetch and install package updates.
  remove  (r)    remove packages.
  clean   (c)    remove orphan packages.
	]]

	print(help)
	return true
end

-- install packages using void linux package manager.
function xbps_install()
	if #arg < 2 then
		exit("please provide a package name to install.")
	end

	local pkgs = get_pkg_array()
	local cmd = "sudo xbps-install -Sy " .. collect_pkgs(pkgs)
	return exec(cmd)
end

-- search packages using void linux package manager.
function xbps_search()
	local pkg = arg[2]
	if pkg == nil then
		exit("please provide a package name to search.")
	end
	return exec("xbps-query -Rs " .. pkg)
end

-- update void system packages.
function xbps_update()
    return exec("sudo xbps-install -Syu")
end

-- remove void linux package.
function xbps_remove()
	if #arg < 2 then
		exit("please provide a package name to remove.")
	end

	local pkgs = get_pkg_array()
	local s = exec("sudo xbps-remove -R " .. collect_pkgs(pkgs))
	if not s then
    	return s
	end
	return xbps_clean()
end

-- clean orphaned packages in void linux.
function xbps_clean()
    return exec("sudo xbps-remove -Oo")
end

-- process user command using void linux package manager.
function xbps_process_command(cmd)
	if cmd == "help" or cmd == "h" then
    	return print_help()
	elseif cmd == "install" or cmd == "i" then
    	return xbps_install()
	elseif cmd == "search" or cmd == "s" then
    	return xbps_search()
	elseif cmd == "update" or cmd == "u" then
    	return xbps_update()
	elseif cmd == "remove" or cmd == "r" then
    	return xbps_remove()
	elseif cmd == "clean" or cmd == "c" then
		return xbps_clean()    	
	else
    	exit("invalid command")
	end
end

-- program entrypoint.
function main()
	local cmd = arg[1]
	if cmd == nil then
    	exit("please provide a command to continue.")
	end

	local success = xbps_process_command(cmd)
	if not success then
    	exit("failed to complete command.")
	end
end


main()
